@model IEnumerable<WebBanGiayTheThao.Models.Voucher>
@{
    var myVouchers = ViewBag.MyVouchers as List<WebBanGiayTheThao.Models.UserVoucher> ?? new List<WebBanGiayTheThao.Models.UserVoucher>();

    var listDaLuu = ViewBag.DaLuu as Dictionary<int, List<decimal>> ?? new Dictionary<int, List<decimal>>();
}

<div class="container py-5">
    <div class="text-center mb-5 p-4 bg-white mx-auto shadow-sm" style="border: 2px dashed #dc3545; border-radius: 25px; max-width: 800px; background-color: #fff5f5;">
        <h1 class="display-5 fw-bold text-danger text-uppercase mb-2">
            <i class="bi bi-gift-fill me-2"></i>KHO MÃ GIẢM GIÁ
        </h1>
        <p class="lead text-dark fw-semibold mb-0">Săn ngay những mã giảm giá cực hot!</p>
    </div>

    @* --- PHẦN 1: VOUCHER CỦA BẠN (SỬ DỤNG DỮ LIỆU ĐÃ LƯU - SNAPSHOT) --- *@
    <div class="mb-5">
        <h3 class="fw-bold mb-4 text-dark"><i class="bi bi-wallet2 text-success me-2"></i>Voucher của bạn</h3>
        <div class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-3">
            @if (myVouchers.Any())
            {
                @foreach (var uv in myVouchers)
                {
                    <div class="col">
                        @* Thẻ voucher sử dụng dữ liệu đã đóng băng trong bảng UserVoucher *@
                        <div class="card border-0 shadow-sm h-100" style="background: linear-gradient(to right, #ffffff 70%, #f0fff4 30%); border-left: 5px solid #198754 !important;">
                            <div class="card-body p-3 d-flex justify-content-between align-items-center">
                                <div>
                                    @* Lấy MaCodeLuu thay vì uv.Voucher.MaCode *@
                                    <div class="fw-bold text-success text-uppercase small">@uv.MaCodeLuu</div>

                                    @* Giá trị giảm lúc lưu *@
                                    <div class="h5 m-0 fw-bold text-dark">Giảm @(uv.GiaTriGiamLuu?.ToString("#,##0"))đ</div>

                                    @* Thời hạn sử dụng lúc lưu *@
                                    <div class="text-muted" style="font-size: 11px;">
                                        HSD: @uv.NgayBatDauLuu?.ToString("dd/MM") - @uv.NgayKetThucLuu?.ToString("dd/MM/yyyy")
                                    </div>
                                </div>
                                <div class="ps-2 text-center">
                                    <button type="button"
                                            class="btn btn-sm btn-success rounded-pill px-3 fw-bold shadow-sm"
                                            onclick="copyToClipboard('@uv.MaCodeLuu', this)">
                                        SAO CHÉP
                                    </button>
                                    <div class="text-success mt-1 d-none msg-copy" style="font-size: 10px;">Đã copy!</div>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            }
            else
            {
                <div class="col-12 text-center py-4 bg-light rounded-3 border">
                    <p class="text-muted mb-0 small italic">Bạn chưa sở hữu mã giảm giá nào.</p>
                </div>
            }
        </div>
    </div>

    <hr class="my-5 opacity-25" />

    <h3 class="fw-bold mb-4 text-dark"><i class="bi bi-fire text-danger me-2"></i>Săn thêm mã mới</h3>
    <div class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4">
        @if (Model != null && Model.Any())
        {
            @foreach (var item in Model)
            {
                var cacMucTienUserCo = listDaLuu.ContainsKey(item.Id) ? listDaLuu[item.Id] : new List<decimal>();
                bool daCoBanNay = cacMucTienUserCo.Contains(item.GiaTriGiam.GetValueOrDefault());
                bool hetHang = item.SoLuong < 1;

                <div class="col">
                    <div class="card mb-3 border-0 shadow-sm h-100 overflow-hidden @(hetHang && !daCoBanNay ? "opacity-75" : "")">
                        <div class="row g-0 h-100">
                            <div class="col-4 @(hetHang && !daCoBanNay ? "bg-secondary" : "bg-danger") text-white d-flex flex-column align-items-center justify-content-center py-3">
                                <i class="bi bi-ticket-perforated-fill fs-1 mb-2"></i>
                                <h3 class="fw-bold m-0">@((item.GiaTriGiam.GetValueOrDefault() / 1000).ToString("#,##0"))K</h3>
                            </div>

                            <div class="col-8">
                                <div class="card-body p-3 h-100 d-flex flex-column justify-content-between">
                                    <div>
                                        <h5 class="card-title fw-bold text-dark">@item.MaCode</h5>
                                        <p class="card-text text-secondary small mb-0">Đơn từ: @item.GiaTriDonToiThieu.GetValueOrDefault().ToString("#,##0") đ</p>
                                        <p class="card-text text-muted small" style="font-size: 11px;">HSD: @item.NgayKetThuc?.ToString("dd/MM/yyyy")</p>
                                    </div>

                                    <div class="d-flex justify-content-between align-items-center mt-2">
                                        <span class="small text-secondary">SL: <b>@item.SoLuong</b></span>

                                        @if (daCoBanNay)
                                        {
                                            <button class="btn btn-sm btn-success px-3 rounded-pill text-white" disabled>Đã sở hữu</button>
                                        }
                                        else if (hetHang)
                                        {
                                            <button class="btn btn-sm btn-secondary px-3 rounded-pill" disabled>Hết lượt</button>
                                        }
                                        else
                                        {
                                            <button class="btn btn-sm btn-outline-danger px-3 rounded-pill fw-bold"
                                                    onclick="luuVoucher(this, @item.Id)">
                                                @(cacMucTienUserCo.Count > 0 ? "Cập nhật" : "Lưu")
                                            </button>
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }
        }
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
@section Scripts {
    <script>
        // 1. Hàm Copy (Giữ nguyên)
        function copyToClipboard(text, btn) {
            if (!text) return;
            navigator.clipboard.writeText(text).then(function() {
                const originalText = btn.innerText;
                btn.innerText = "OK!";
                btn.classList.replace("btn-success", "btn-dark");
                const msg = btn.parentElement.querySelector(".msg-copy");
                if(msg) msg.classList.remove("d-none");

                setTimeout(() => {
                    btn.innerText = originalText;
                    btn.classList.replace("btn-dark", "btn-success");
                    if(msg) msg.classList.add("d-none");
                }, 2000);
            });
        }

        // 2. Hàm Lưu Voucher (Đã sửa theo ý bạn)
        function luuVoucher(btn, idCuaVoucher) {
            // Chỉ cần disable nút để tránh user bấm liên tục 2 lần
            if (btn.disabled) return;
            btn.disabled = true;

            // LƯU Ý: Không đổi text thành "Đang xử lý" nữa, giữ nguyên nút cũ

            fetch('/Voucher/LuuVoucher?voucherId=' + idCuaVoucher, { method: 'POST' })
                .then(res => res.json())
                .then(thanhCong => {
                    if (thanhCong) {
                        // Hiện thông báo đẹp (SweetAlert)
                        Swal.fire({
                            icon: 'success',
                            title: 'Lưu thành công!',
                            text: 'Mã đã được thêm vào ví của bạn.',
                            showConfirmButton: false, // Ẩn nút OK để tự tắt
                            timer: 1500 // Hiện trong 1.5 giây
                        }).then(() => {
                            // Sau khi thông báo tắt thì mới reload trang
                            location.reload();
                        });
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Thất bại',
                            text: 'Mã này bạn đã lưu rồi hoặc đã hết lượt!',
                        });
                        // Nếu lỗi thì mở lại nút để bấm lại
                        btn.disabled = false;
                    }
                })
                .catch(err => {
                    console.error(err);
                    Swal.fire('Lỗi', 'Có lỗi xảy ra, vui lòng thử lại sau.', 'error');
                    btn.disabled = false;
                });
        }
    </script>
}