@model WebBanGiayTheThao.Models.SanPham

@{
    ViewData["Title"] = Model.TenSanPham;

    // Tập hợp tất cả ảnh của sản phẩm: Ảnh đại diện + Ảnh chi tiết
    var allImages = new List<string>();
    if (!string.IsNullOrEmpty(Model.AnhDaiDien)) { allImages.Add(Model.AnhDaiDien); }
    if (Model.Ctanhs != null) { allImages.AddRange(Model.Ctanhs.Select(x => x.LinkAnh)); }
}
<div class="bg-gray-50 min-h-screen pb-20 font-sans">
    <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-6 mt-4 max-w-[1300px]">

        <nav class="flex text-sm text-gray-500 mb-6 overflow-x-auto whitespace-nowrap px-2">
            <a asp-controller="Home" asp-action="TrangChu" class="hover:text-black transition-colors">Trang chủ</a>
            <span class="mx-2">/</span>
            <a class="hover:text-black transition-colors">@Model.LoaiSanPham?.TenLoai</a>
            <span class="mx-2">/</span>
            <span class="text-black font-medium truncate">@Model.TenSanPham</span>
        </nav>

        <form asp-controller="GioHang" method="post">
            <input type="hidden" name="productId" value="@Model.Id" />
            <input type="hidden" name="soLuong" value="1" />

            <div class="bg-white rounded-[40px] p-8 lg:p-16 shadow-lg mb-12">
                <div class="grid grid-cols-1 lg:grid-cols-12 gap-12 xl:gap-20 items-start">

                    <div class="lg:col-span-8 flex flex-col-reverse lg:flex-row gap-4">

                        <div id="gallery-thumbs" class="flex lg:flex-col gap-3 overflow-x-auto lg:overflow-y-auto lg:w-20 lg:h-[500px] no-scrollbar py-1">
                            @foreach (var img in allImages)
                            {
                                <div class="flex-shrink-0 w-16 h-16 lg:w-20 lg:h-20 cursor-pointer border-2 border-transparent hover:border-black rounded-xl overflow-hidden transition-all duration-200"
                                     onclick="changeImage(this, '@Url.Content($"~/img/sanpham/{img}")')">
                                    <img src="~/img/sanpham/@img" class="w-full h-full object-cover" onerror="this.src='/img/no-image.jpg'">
                                </div>
                            }
                        </div>

                        <div class="flex-1 bg-gray-100 rounded-2xl overflow-hidden relative aspect-square group">
                            <img id="main-image"
                                 src="~/img/sanpham/@Model.AnhDaiDien"
                                 alt="@Model.TenSanPham"
                                 class="w-full h-full object-cover object-center transition-transform duration-500 group-hover:scale-105"
                                 onerror="this.src='/img/no-image.jpg'">
                        </div>
                    </div>

                    <div class="lg:col-span-4 space-y-8">

                        <div>
                            <h1 class="text-2xl lg:text-3xl font-bold tracking-tight text-gray-900 leading-tight">@Model.TenSanPham</h1>
                        </div>                     
                        <div>
                            <p class="text-gray-500 mt-2">@Model.LoaiSanPham?.TenLoai Nam</p>
                            <p class="text-3xl font-extrabold text-black mt-4">
                                @((Model.DonGia ?? 0).ToString("N0")) ₫
                            </p>
                        </div>

                        <div>
                            <h3 class="font-bold text-sm text-gray-900 mb-3">Chọn Màu Sắc</h3>
                            <div class="flex gap-3">

                                @if (ViewBag.CacMauKhac != null)
                                {
                                    @foreach (var item in ViewBag.CacMauKhac)
                                    {
                                        bool isActive = item.Id == Model.Id;

                                        // Nếu là màu đang xem: Viền đen đậm. Nếu màu khác: Viền trong suốt, hover vào mới hiện viền
                                        string borderClass = isActive
                                        ? "border-black ring-1 ring-black"  // Active
                                        : "border-transparent hover:border-gray-400"; // Inactive

                                        // Tạo đường dẫn: Nếu bấm vào màu khác -> Chuyển sang trang chi tiết của ID đó
                                        string url = isActive ? "javascript:void(0)" : Url.Action("TrangChiTietSanPham", "SanPham", new { id = item.Id });

                                        <a href="@url"
                                           class="block w-20 h-20 rounded-xl border-2 p-1 cursor-pointer transition-all duration-200 @borderClass"
                                           title="@item.TenSanPham">

                                            <img src="~/img/sanpham/@item.AnhDaiDien" asp-append-version="true"
                                                 class="w-full h-full object-cover rounded-lg"
                                                 onerror="this.src='/img/no-image.jpg'">
                                        </a>
                                    }
                                }
                            </div>
                        </div>
                       
                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="font-bold text-sm text-gray-900">Chọn Size</h3>
                            </div>

                            <div class="grid grid-cols-3 gap-2" id="size-container">
                                @if (Model.Ctsizes != null && Model.Ctsizes.Any())
                                {
                                    @foreach (var size in Model.Ctsizes.OrderBy(x => x.Size))
                                    {
                                        <label class="cursor-pointer w-full block">
                                            <input type="radio" name="sizeId" value="@size.Id" class="peer sr-only" required>

                                            <div class="size-btn h-12 flex items-center justify-center rounded-xl border border-gray-300 font-bold text-sm transition-all duration-200
                                    hover:border-black hover:bg-black hover:text-white
                                    peer-checked:bg-black peer-checked:text-white peer-checked:border-black">
                                                @size.Size
                                            </div>
                                        </label>
                                    }
                                }
                                else
                                {
                                    <span class="col-span-full text-red-500 text-sm italic">Hết size.</span>
                                }
                            </div>
                            <p id="size-error" class="text-red-500 text-xs mt-2 hidden">Vui lòng chọn size.</p>
                        </div>

                        <div class="space-y-4 pt-2">
                            <button type="submit" 
                                    class="w-full py-4 rounded-full border border-black bg-white text-black font-bold text-sm hover:bg-gray-50 transition-all flex justify-center items-center gap-2">
                                <i class="ph ph-shopping-cart text-lg"></i> Thêm vào giỏ hàng
                            </button>
                            <button type="submit"
                                    class="w-full py-4 rounded-full bg-black text-white font-bold text-sm hover:bg-gray-800 transition-all shadow-lg transform active:scale-[0.99]">
                                Mua ngay
                            </button>
                        </div>

                        <div class="border-t border-gray-100 pt-6">
                            <div x-data="{ open: true }">
                                <button  class="flex w-full justify-between items-center text-left font-bold text-gray-900 hover:text-gray-600 transition" >
                                    <span>Mô tả sản phẩm</span>
                                </button>
                                <div>
                                    @Model.MoTa
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </form>

        @await Component.InvokeAsync("BinhLuan", new { spId = Model.Id })

        <div>
            <div class="flex justify-between items-end mb-8 px-2">
                <h2 class="text-2xl font-bold">Sản phẩm liên quan</h2>
                <a href="#" class="text-sm underline hover:text-gray-500">Xem tất cả</a>
            </div>

            <div id="related-products-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-6">
                <div class="bg-white p-4 rounded-2xl shadow-sm">
                    <div class="aspect-square bg-gray-100 rounded-xl mb-3"></div>
                    <div class="h-4 bg-gray-100 rounded w-3/4 mb-2"></div>
                    <div class="h-4 bg-gray-100 rounded w-1/2"></div>
                </div>
                <div class="bg-white p-4 rounded-2xl shadow-sm">
                    <div class="aspect-square bg-gray-100 rounded-xl mb-3"></div>
                    <div class="h-4 bg-gray-100 rounded w-3/4 mb-2"></div>
                    <div class="h-4 bg-gray-100 rounded w-1/2"></div>
                </div>
                <div class="bg-white p-4 rounded-2xl shadow-sm">
                    <div class="aspect-square bg-gray-100 rounded-xl mb-3"></div>
                    <div class="h-4 bg-gray-100 rounded w-3/4 mb-2"></div>
                    <div class="h-4 bg-gray-100 rounded w-1/2"></div>
                </div>
                <div class="bg-white p-4 rounded-2xl shadow-sm">
                    <div class="aspect-square bg-gray-100 rounded-xl mb-3"></div>
                    <div class="h-4 bg-gray-100 rounded w-3/4 mb-2"></div>
                    <div class="h-4 bg-gray-100 rounded w-1/2"></div>
                </div>
            </div>
        </div>

    </main>
</div>

@section Scripts {
    <script>
        // Chọn các ảnh phụ để phóng to ở ảnh chính 
        function changeImage(element, src) {
            var mainImg = document.getElementById('main-image'); // lấy ảnh chính đang hiện
            mainImg.style.opacity = '0.2'; // hiệu ứng mờ
            setTimeout(function() {
                mainImg.src = src;
                mainImg.style.opacity = '0.5';
            }, 200);// thười gian đổi ảnh

            // xóa viền cũ màu đen và đổi màu thành trắng
            var thumbs = document.querySelectorAll('#gallery-thumbs div');
            thumbs.forEach(t => {
                t.classList.remove('border-black');
                t.classList.add('border-transparent');
            });

            //thêm viền đen
            element.classList.remove('border-transparent');
            element.classList.add('border-black');
        }
    </script>
}