@model IEnumerable<WebBanGiayTheThao.ViewModels.DonHang.OrderHistoryVM>

@{
    ViewData["Title"] = "Lịch sử đơn hàng";
}

<div class="container py-4">

    <!-- TIÊU ĐỀ -->
    <div class="mb-4">
        <h4 class="fw-bold">Lịch sử đơn hàng</h4>
        <p class="text-muted mb-0">
            Theo dõi các đơn hàng bạn đã đặt trên hệ thống
        </p>
    </div>

    <!-- TRA CỨU + TAB -->
    <div class="card border-0 shadow-sm rounded-4 mb-4">
        <div class="card-body">

            <div class="row g-3 align-items-center">

                <!-- SEARCH -->
                <div class="col-md-6">
                    <div class="input-group">
                        <input type="text"
                               id="searchOrderInput"
                               class="form-control rounded-start-pill px-4"
                               placeholder="Nhập mã đơn hàng..." />

                        <button class="btn btn-dark rounded-end-pill px-4"
                                id="searchBtn">
                            <i class="bi bi-search"></i>
                        </button>
                    </div>
                </div>

                <!-- STATUS TABS -->
                <div class="col-md-6 text-md-end">
                    <ul class="nav nav-pills justify-content-md-end gap-2"
                        id="orderStatusTabs">

                        <li class="nav-item">
                            <a class="nav-link active rounded-pill px-4"
                               data-status="All">
                                Tất cả
                            </a>
                        </li>

                        <li class="nav-item">
                            <a class="nav-link rounded-pill px-4"
                               data-status="Approved">
                                Đã duyệt
                            </a>
                        </li>

                        <li class="nav-item">
                            <a class="nav-link rounded-pill px-4"
                               data-status="Completed">
                                Hoàn thành
                            </a>
                        </li>

                        <li class="nav-item">
                            <a class="nav-link rounded-pill px-4"
                               data-status="Canceled">
                                Đã hủy
                            </a>
                        </li>

                    </ul>
                </div>

            </div>

        </div>
    </div>

    <!-- DANH SÁCH ĐƠN -->
    @if (!Model.Any())
    {
        <!-- EMPTY STATE -->
        <div class="text-center py-5">
            <img src="https://cdn-icons-png.flaticon.com/512/2038/2038854.png"
                 width="120"
                 class="mb-3" />
            <h5 class="fw-bold">Bạn chưa có đơn hàng nào</h5>
            <p class="text-muted">
                Hãy mua sắm để trải nghiệm dịch vụ của chúng tôi
            </p>
        </div>
    }
    else
    {
        <div class="card border-0 shadow-sm rounded-4">
            <div class="card-body p-0">

                <table class="table align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Mã đơn</th>
                            <th>Ngày đặt</th>
                            <th>Tổng tiền</th>
                            <th>Trạng thái</th>
                            <th class="text-end"></th>
                        </tr>
                    </thead>

                    <tbody id="orderTableBody">
                        @foreach (var order in Model)
                        {
                            <tr data-status="@order.Status"
                                data-ordercode="@order.OrderCode">

                                <td class="fw-semibold">@order.OrderCode</td>

                                <td>@order.OrderDate.ToString("dd/MM/yyyy")</td>

                                <td class="fw-bold text-danger">
                                    @order.TotalAmount.ToString("N0") ₫
                                </td>

                                <td>
                                    @if (order.Status == "Approved")
                                    {
                                        <span class="badge bg-warning text-dark">
                                            Đã duyệt
                                        </span>
                                    }
                                    else if (order.Status == "Completed")
                                    {
                                        <span class="badge bg-success">
                                            Hoàn thành
                                        </span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-secondary">
                                            Đã hủy
                                        </span>
                                    }
                                </td>

                                <td class="text-end">
                                    <button class="btn btn-outline-dark btn-sm rounded-pill px-3"
                                            data-bs-toggle="modal"
                                            data-bs-target="#orderDetailModal"
                                            data-ordercode="@order.OrderCode"
                                            data-status="@order.Status">
                                        Xem chi tiết
                                    </button>
                                </td>

                            </tr>
                        }
                    </tbody>

                </table>

            </div>
        </div>
    }

</div>

<!-- MODAL CHI TIẾT ĐƠN -->
@Html.Partial("_ChiTietDonHangModal")

<!-- SCRIPT -->
<script>
    const tabs = document.querySelectorAll('#orderStatusTabs .nav-link');
    const rows = document.querySelectorAll('#orderTableBody tr');
    const searchInput = document.getElementById('searchOrderInput');
    const searchBtn = document.getElementById('searchBtn');

    let currentStatus = "All";

    tabs.forEach(tab => {
        tab.addEventListener('click', function (e) {
            e.preventDefault();

            tabs.forEach(t => t.classList.remove('active'));
            this.classList.add('active');

            currentStatus = this.dataset.status;
            filterOrders();
        });
    });

    searchBtn.addEventListener('click', filterOrders);

    searchInput.addEventListener('keyup', function (e) {
        if (e.key === "Enter") filterOrders();
    });

    function filterOrders() {
        const keyword = searchInput.value.toLowerCase();

        rows.forEach(row => {
            const status = row.dataset.status;
            const orderCode = row.dataset.ordercode.toLowerCase();

            const matchStatus =
                currentStatus === "All" || status === currentStatus;

            const matchKeyword =
                keyword === "" || orderCode.includes(keyword);

            row.style.display =
                (matchStatus && matchKeyword) ? "" : "none";
        });
    }

    const orderModal = document.getElementById('orderDetailModal');

    orderModal.addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget;

        const orderCode = button.dataset.ordercode;
        const status = button.dataset.status;

        document.getElementById('modalOrderCode').innerText = orderCode;
        document.getElementById('modalOrderDate').innerText = 'Đang cập nhật';

        const badge = document.getElementById('modalStatusBadge');
        const cancelBtn = document.getElementById('cancelBtn');
        const reviewBtn = document.getElementById('reviewBtn');

        badge.className = 'badge';
        cancelBtn.classList.add('d-none');
        reviewBtn.classList.add('d-none');

        if (status === 'Approved') {
            badge.classList.add('bg-warning', 'text-dark');
            badge.innerText = 'Đã duyệt';
            cancelBtn.classList.remove('d-none');
        }
        else if (status === 'Completed') {
            badge.classList.add('bg-success');
            badge.innerText = 'Hoàn thành';
            reviewBtn.classList.remove('d-none');
        }
        else {
            badge.classList.add('bg-secondary');
            badge.innerText = 'Đã hủy';
        }
    });
</script>
