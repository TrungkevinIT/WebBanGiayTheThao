@using WebBanGiayTheThao.Models;
@model SanPham
@{
    Layout = "_LayoutAdmin";
}
<div class="container-fluid pt-4 px-4">
    <div class="bg-light rounded h-100 p-4">
        <h4 class="mb-4 text-primary"><i class="fa fa-cube me-2"></i>THÊM SẢN PHẨM MỚI</h4>

        <form asp-action="TrangThemSanPham" method="post" enctype="multipart/form-data" id="formSanPham">
            <div class="row g-4">

                <div class="col-md-4">
                    <div class="card shadow-sm">
                        <div class="card-header bg-white fw-bold">Hình ảnh</div>
                        <div class="card-body text-center">
                            <label class="form-label fw-bold small">Ảnh đại diện chính (*)</label>

                            <div class="img-preview-box mb-3" onclick="document.getElementById('MainImageInput').click()">
                                <img id="MainPreview" src="" class="d-none" />
                                <i id="MainIcon" class="fa fa-cloud-upload-alt"></i>
                            </div>

                            <input asp-for="ImageFile" id="MainImageInput" type="file"
                                   style="opacity:0; position:absolute; z-index:-1;"
                                   accept="image/*" onchange="previewSingle(this)" />

                            <span asp-validation-for="ImageFile" class="text-danger small"></span>

                            <hr />

                            <label class="form-label fw-bold small text-start w-100">Ảnh phụ (Chọn nhiều)</label>
                            <input asp-for="ListAnhPhu" type="file" class="form-control form-control-sm" multiple accept="image/*" onchange="previewGallery(this)" required />
                            <span asp-validation-for="ListAnhPhu" class="text-danger small"></span>
                            <div class="gallery-container" id="GalleryPreview"></div>
                  
                        </div>
                    </div>
                </div>

                <div class="col-md-8">
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-white fw-bold">Thông tin chi tiết</div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-8">
                                    <label class="form-label">Tên sản phẩm</label>
                                    <input asp-for="TenSanPham" class="form-control" placeholder="Nhập tên sản phẩm..." />
                                    <span asp-validation-for="TenSanPham" class="text-danger small"></span>
                                </div>
                                <div class="col-md-8">
                                    <label class="form-label">Mã Kiểu Dáng</label>
                                    <input asp-for="MaKieuDang" class="form-control" placeholder="Nhập Mã Kiểu Dáng(Nhóm Màu)..." />
                                    <span asp-validation-for="MaKieuDang" class="text-danger small"></span>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Đơn giá (VNĐ)</label>
                                    <input asp-for="DonGia" type="number" class="form-control"/>
                                    <span asp-validation-for="DonGia" class="text-danger small"></span>
                                </div>
                            </div>

                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">Loại sản phẩm</label>
                                    <div class="input-group">
                                        <select asp-for="LoaiSanPhamId" id="ddlLoai" class="form-select" asp-items="ViewBag.DanhSachLoaiSanPham">
                                          
                                        </select>
                                        <button class="btn btn-outline-secondary" type="button" onclick="openModal('Loại sản phẩm', 'Loai')"><i class="fa fa-plus"></i></button>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Thương hiệu</label>
                                    <div class="input-group">
                                        <select asp-for="ThuongHieuId" id="ddlThuongHieu" class="form-select" asp-items="ViewBag.DanhSachThuongHieu">
                                            
                                        </select>
                                        <button class="btn btn-outline-secondary" type="button" onclick="openModal('Thương hiệu', 'ThuongHieu')"><i class="fa fa-plus"></i></button>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Mô tả sản phẩm</label>
                                <textarea asp-for="MoTa" class="form-control" rows="3"></textarea>
                                <span asp-validation-for="MoTa" class="text-danger small"></span>
                            </div>
                        </div>
                    </div>

                    <div class="card shadow-sm">
                        <div class="card-header bg-white d-flex justify-content-between align-items-center">
                            <span class="fw-bold">Quản lý Phiên bản (Size & Số lượng)</span>
                            <button type="button" class="btn btn-sm btn-success" onclick="themDongSize()">
                                <i class="fa fa-plus-circle me-1"></i> Thêm Size
                            </button>
                        </div>
                        <div class="card-body p-0">
                            <table class="table table-bordered table-striped mb-0 table-size">
                                <thead class="bg-light">
                                    <tr>
                                        <th class="text-center">Kích thước (Size)</th>
                                        <th class="text-center">Số lượng nhập kho</th>
                                        <th class="text-center" style="width: 50px;">#</th>
                                    </tr>
                                </thead>
                                <tbody id="tableBodySize">
                                    <tr>
                                        <td><input name="ChiTietSizeNhap[0].Size" type="number" step="0.5" class="form-control form-control-sm" placeholder="VD: 40" min="0" required /></td>
                                        <td><input name="ChiTietSizeNhap[0].SoLuongTon" type="number" class="form-control form-control-sm" value="1" min="0" required /></td>
                                        <td class="text-center"><button type="button" class="btn btn-danger btn-sm disabled"><i class="fa fa-trash"></i></button></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="d-flex justify-content-end mt-4">
                        <a asp-area="Admin" asp-controller="QuanLySanPham" asp-action="TrangQLSanPham" class="btn btn-secondary me-2">Hủy bỏ</a>
                        <button type="submit" class="btn btn-primary px-4"><i class="fa fa-save me-2"></i>Lưu sản phẩm</button>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<div class="modal fade" id="quickAddModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Thêm mới</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="modalType" />

                <div class="mb-3">
                    <label class="form-label">Nhập tên mới:</label>
                    <input type="text" id="modalInputName" class="form-control" placeholder="Nhập tên..." />

                    <span id="errorName" class="text-danger small d-none fw-bold"></span>
                </div>

                <div class="mb-3 d-none" id="divXuatXu">
                    <label class="form-label">Xuất xứ:</label>
                    <input type="text" id="modalInputOrigin" class="form-control" placeholder="Ví dụ: Việt Nam, Mỹ..." />
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-primary" onclick="luuNhanh()">Lưu lại</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        // --- 1. XỬ LÝ ẢNH ---
        function previewSingle(input) {
            if (input.files && input.files[0]) {
                var reader = new FileReader();
                reader.onload = function (e) {
                    $('#MainPreview').attr('src', e.target.result).removeClass('d-none');
                    $('#MainIcon').addClass('d-none');
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function previewGallery(input) {
            var container = $('#GalleryPreview');
            container.empty();
            if (input.files) {
                Array.from(input.files).forEach(file => {
                    var reader = new FileReader();
                    reader.onload = function (e) {
                        var img = $('<img>').addClass('gallery-item').attr('src', e.target.result);
                        container.append(img);
                    }
                    reader.readAsDataURL(file);
                });
            }
        }

        // --- 2. XỬ LÝ SIZE ĐỘNG (Đã sửa tên biến cho đúng Model) ---
        var sizeIndex = 1;
                function themDongSize() {
            var html = `
                <tr>
                    <td>
                        <input name="ChiTietSizeNhap[${sizeIndex}].Size"
                               type="number" step="0.5"
                               class="form-control form-control-sm"
                               min="34" required
                               placeholder="Nhập size..." />
                    </td>

                    <td>
                        <input name="ChiTietSizeNhap[${sizeIndex}].SoLuongTon"
                               type="number"
                               class="form-control form-control-sm"
                               min="1" value="1" required />
                    </td>

                    <td class="text-center">
                        <button type="button" class="btn btn-danger btn-sm" onclick="xoaDong(this)">
                            <i class="fa fa-trash"></i>
                        </button>
                    </td>
                </tr>`;

            $('#tableBodySize').append(html);
            sizeIndex++;
        }
        $('#formSanPham').on('submit', function (e) {
            var coLoi = false;

            // 1. Quét qua TẤT CẢ ô input trong bảng Size (dòng cũ lẫn mới)
            $('#tableBodySize input').each(function () {
                var input = $(this);
                var giaTri = input.val();      // Giá trị người dùng nhập
                var minVal = input.attr('min'); // Lấy cái min="34" hoặc min="1" từ HTML

                // Xóa viền đỏ cũ (nếu có)
                input.removeClass('is-invalid');

                // KIỂM TRA 1: Có nhập chưa? (Thay cho required)
                if (!giaTri) {
                    coLoi = true;
                    input.addClass('is-invalid'); // Tô viền đỏ
                }
                // KIỂM TRA 2: Có nhỏ hơn min không? (Thay cho min="...")
                else if (minVal && parseFloat(giaTri) < parseFloat(minVal)) {
                    coLoi = true;
                    input.addClass('is-invalid'); // Tô viền đỏ
                }
            });

            // 2. Nếu phát hiện lỗi ở bảng Size
            if (coLoi) {
                e.preventDefault(); // CHẶN ĐỨNG việc gửi form
            }
        });

        function xoaDong(btn) {
            $(btn).closest('tr').remove();
        }

        // --- 3. XỬ LÝ THÊM NHANH (AJAX Đã cập nhật) ---
        var myModal = new bootstrap.Modal(document.getElementById('quickAddModal'));

        function openModal(title, type) {
            $('#modalTitle').text('Thêm mới ' + title);
            $('#modalType').val(type);

            // Reset form
            $('#modalInputName').val('');
            $('#modalInputOrigin').val('');
            $('#errorName').addClass('d-none');

            // Logic ẩn hiện ô Xuất xứ
            if (type === 'ThuongHieu') {
                $('#divXuatXu').removeClass('d-none');
            } else {
                $('#divXuatXu').addClass('d-none');
            }

            myModal.show();
        }

               function luuNhanh() {
            var type = $('#modalType').val();
            var name = $('#modalInputName').val().trim();
            var origin = $('#modalInputOrigin').val().trim();

            // 1. Reset trạng thái lỗi cũ (Xóa đỏ, xóa chữ)
            $('#errorName').addClass('d-none').text('');
            $('#modalInputName').removeClass('is-invalid');

            // 2. Kiểm tra rỗng (Validation phía Client)
            if (!name) {
                $('#errorName').text('Vui lòng nhập tên!').removeClass('d-none');
                $('#modalInputName').addClass('is-invalid');
                return; 
            }

            // 3. Gửi AJAX
            $.ajax({
                url: '/Admin/QuanLySanPham/ThemNhanhDuLieu',
                type: 'POST',
                data: { loai: type, ten: name, xuatXu: origin },
                success: function (res) {
                    if (res.success) {
                        var newOption = new Option(res.ten, res.id, true, true);

                        if (type == 'Loai') {
                            $('#ddlLoai').append(newOption).trigger('change');
                        } else {
                            $('#ddlThuongHieu').append(newOption).trigger('change');
                        }

                        myModal.hide();
                       
                    } else {
                        
                        $('#errorName').text(res.message).removeClass('d-none');
                        $('#modalInputName').addClass('is-invalid');
                    }
                },
                error: function () {
                    alert('Lỗi kết nối server!');
                }
            });
        }

        $('#modalInputName').on('input', function() {
            $('#errorName').addClass('d-none');
            $(this).removeClass('is-invalid');
        });
    </script>
}