@{
    Layout = "_LayoutAdmin";
}
<style>
    .img-preview-box {
        width: 100%;
        height: 180px;
        border: 2px dashed #ccc;
        border-radius: 10px;
        display: flex;
        justify-content: center;
        align-items: center;
        overflow: hidden;
        background-color: #f8f9fa;
        position: relative;
        cursor: pointer;
    }

        .img-preview-box img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .img-preview-box i {
            font-size: 40px;
            color: #ccc;
        }

    .gallery-container {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 10px;
    }

    .gallery-item {
        width: 80px;
        height: 80px;
        border: 1px solid #ddd;
        border-radius: 5px;
        object-fit: cover;
    }
    /* Style cho bảng Size */
    .table-size input {
        text-align: center;
    }
</style>
<div class="container-fluid pt-4 px-4">
    <div class="bg-light rounded h-100 p-4">
        <h4 class="mb-4 text-primary"><i class="fa fa-cube me-2"></i>THÊM SẢN PHẨM MỚI</h4>

        <form asp-action="Create" method="post" enctype="multipart/form-data" id="formSanPham">
            <div class="row g-4">

                <div class="col-md-4">
                    <div class="card shadow-sm">
                        <div class="card-header bg-white fw-bold">Hình ảnh</div>
                        <div class="card-body text-center">
                            <label class="form-label fw-bold small">Ảnh đại diện chính (*)</label>
                            <div class="img-preview-box mb-3" onclick="document.getElementById('MainImageInput').click()">
                                <img id="MainPreview" src="" class="d-none" />
                                <i id="MainIcon" class="fa fa-cloud-upload-alt"></i>
                            </div>
                            <input id="MainImageInput" type="file" class="d-none" accept="image/*" onchange="previewSingle(this)" />
                            <span class="text-danger small"></span>

                            <hr />

                            <label class="form-label fw-bold small text-start w-100">Ảnh phụ (Chọn nhiều)</label>
                            <input type="file" class="form-control form-control-sm" multiple accept="image/*" onchange="previewGallery(this)" />
                            <div class="gallery-container" id="GalleryPreview"></div>
                        </div>
                    </div>
                </div>

                <div class="col-md-8">
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-white fw-bold">Thông tin chi tiết</div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-8">
                                    <label class="form-label">Tên sản phẩm</label>
                                    <input class="form-control" placeholder="Nhập tên sản phẩm..." />
                                    <span class="text-danger small"></span>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Đơn giá (VNĐ)</label>
                                    <input type="number" class="form-control" value="0" />
                                </div>
                            </div>

                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">Loại sản phẩm</label>
                                    <div class="input-group">
                                        <select id="ddlLoai" class="form-select" asp-items="ViewBag.LoaiSP">
                                            <option value="">-- Chọn Loại --</option>
                                        </select>
                                        <button class="btn btn-outline-secondary" type="button" onclick="openModal('Loại sản phẩm', 'Loai')"><i class="fa fa-plus"></i></button>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Thương hiệu</label>
                                    <div class="input-group">
                                        <select id="ddlThuongHieu" class="form-select" asp-items="ViewBag.ThuongHieu">
                                            <option value="">-- Chọn Thương Hiệu --</option>
                                        </select>
                                        <button class="btn btn-outline-secondary" type="button" onclick="openModal('Thương hiệu', 'ThuongHieu')"><i class="fa fa-plus"></i></button>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Mô tả sản phẩm</label>
                                <textarea class="form-control" rows="3"></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="card shadow-sm">
                        <div class="card-header bg-white d-flex justify-content-between align-items-center">
                            <span class="fw-bold">Quản lý Phiên bản (Size & Số lượng)</span>
                            <button type="button" class="btn btn-sm btn-success" onclick="themDongSize()">
                                <i class="fa fa-plus-circle me-1"></i> Thêm Size
                            </button>
                        </div>
                        <div class="card-body p-0">
                            <table class="table table-bordered table-striped mb-0 table-size">
                                <thead class="bg-light">
                                    <tr>
                                        <th class="text-center">Kích thước (Size)</th>
                                        <th class="text-center">Số lượng nhập kho</th>
                                        <th class="text-center" style="width: 50px;">#</th>
                                    </tr>
                                </thead>
                                <tbody id="tableBodySize">
                                    <tr>
                                        <td><input name="DanhSachSize[0].Size" type="number" step="0.5" class="form-control form-control-sm" placeholder="VD: 40" required /></td>
                                        <td><input name="DanhSachSize[0].SoLuongTon" type="number" class="form-control form-control-sm" value="1" required /></td>
                                        <td class="text-center"><button type="button" class="btn btn-danger btn-sm disabled"><i class="fa fa-trash"></i></button></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="d-flex justify-content-end mt-4">
                        <a href="/Admin/SanPham" class="btn btn-secondary me-2">Hủy bỏ</a>
                        <button type="submit" class="btn btn-primary px-4"><i class="fa fa-save me-2"></i>Lưu sản phẩm</button>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<div class="modal fade" id="quickAddModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Thêm mới</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="modalType" />
                <label class="form-label">Nhập tên mới:</label>
                <input type="text" id="modalInputName" class="form-control" />
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-primary" onclick="luuNhanh()">Lưu lại</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        // --- 1. XỬ LÝ ẢNH ---
        function previewSingle(input) {
            if (input.files && input.files[0]) {
                var reader = new FileReader();
                reader.onload = function (e) {
                    $('#MainPreview').attr('src', e.target.result).removeClass('d-none');
                    $('#MainIcon').addClass('d-none');
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function previewGallery(input) {
            var container = $('#GalleryPreview');
            container.empty();
            if (input.files) {
                Array.from(input.files).forEach(file => {
                    var reader = new FileReader();
                    reader.onload = function (e) {
                        var img = $('<img>').addClass('gallery-item').attr('src', e.target.result);
                        container.append(img);
                    }
                    reader.readAsDataURL(file);
                });
            }
        }

        // --- 2. XỬ LÝ SIZE ĐỘNG ---
        var sizeIndex = 1;
        function themDongSize() {
            var html = `
                <tr>
                    <td><input name="DanhSachSize[${sizeIndex}].Size" type="number" step="0.5" class="form-control form-control-sm" required /></td>
                    <td><input name="DanhSachSize[${sizeIndex}].SoLuongTon" type="number" class="form-control form-control-sm" value="1" required /></td>
                    <td class="text-center"><button type="button" class="btn btn-danger btn-sm" onclick="xoaDong(this)"><i class="fa fa-trash"></i></button></td>
                </tr>`;
            $('#tableBodySize').append(html);
            sizeIndex++;
        }

        function xoaDong(btn) {
            $(btn).closest('tr').remove();
        }

        // --- 3. XỬ LÝ THÊM NHANH (AJAX) ---
        var myModal = new bootstrap.Modal(document.getElementById('quickAddModal'));

        function openModal(title, type) {
            $('#modalTitle').text('Thêm mới ' + title);
            $('#modalType').val(type);
            $('#modalInputName').val('');
            myModal.show();
        }

        function luuNhanh() {
            var type = $('#modalType').val(); // 'Loai' hoặc 'ThuongHieu'
            var name = $('#modalInputName').val();

            if(!name) { alert('Vui lòng nhập tên!'); return; }

            // Gọi AJAX (Bạn cần có Action ThemNhanhDuLieu trong Controller)
            $.ajax({
                url: '/Admin/SanPham/ThemNhanhDuLieu',
                type: 'POST',
                data: { loai: type, ten: name },
                success: function (res) {
                    if (res.success) {
                        var newOption = new Option(res.ten, res.id, true, true);
                        if (type == 'Loai') $('#ddlLoai').append(newOption).trigger('change');
                        else $('#ddlThuongHieu').append(newOption).trigger('change');

                        myModal.hide();
                    } else {
                        alert('Lỗi: ' + res.message);
                    }
                },
                error: function() { alert('Lỗi kết nối server!'); }
            });
        }
    </script>
}