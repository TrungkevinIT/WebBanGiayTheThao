@using WebBanGiayTheThao.Models;
@model SanPham
@{
    Layout = "_LayoutAdmin";
}
<div class="container-fluid pt-4 px-4">
    <div class="bg-light rounded h-100 p-4">
        <h4 class="mb-4 text-primary"><i class="fa fa-edit me-2"></i>CẬP NHẬT SẢN PHẨM</h4>

        <form asp-action="TrangCapNhatSanPham" method="post" enctype="multipart/form-data" id="formSanPham">

            <input type="hidden" asp-for="Id" />
            <input type="hidden" asp-for="AnhDaiDien" />
            <input type="hidden" name="trangThaiBool" value="@(Model.TrangThai == 1 ? "true" : "false")" />

            <div class="row g-4">
                <div class="col-md-4">
                    <div class="card shadow-sm">
                        <div class="card-header bg-white fw-bold">Hình ảnh</div>
                        <div class="card-body text-center">
                            <label class="form-label fw-bold small">Ảnh đại diện chính (*)</label>
                            <div class="img-preview-box mb-3" onclick="document.getElementById('MainImageInput').click()">
                                @if (!string.IsNullOrEmpty(Model.AnhDaiDien))
                                {
                                    <img id="MainPreview" src="~/img/sanpham/@Model.AnhDaiDien" />
                                    <i id="MainIcon" class="fa fa-cloud-upload-alt d-none"></i>
                                }
                                else
                                {
                                    <img id="MainPreview" src="" class="d-none" />
                                    <i id="MainIcon" class="fa fa-cloud-upload-alt"></i>
                                }
                            </div>
                            <input asp-for="ImageFile" id="MainImageInput" type="file" class="d-none" accept="image/*" onchange="previewSingle(this)" />
                            <span asp-validation-for="ImageFile" class="text-danger small"></span>

                            <hr />
                            <label class="form-label fw-bold small text-start w-100">Ảnh phụ (Chọn thêm để thay thế)</label>
                            <div class="d-flex flex-wrap gap-2 mb-2">
                                @if (Model.Ctanhs != null)
                                {
                                    foreach (var item in Model.Ctanhs)
                                    {
                                        <img src="~/img/anhphu/@item.LinkAnh" class="gallery-item" title="Ảnh hiện có" />
                                    }
                                }
                            </div>
                            <input asp-for="ListAnhPhu" type="file" class="form-control form-control-sm" multiple accept="image/*" onchange="previewGallery(this)" data-val="false" />
                            <div class="gallery-container" id="GalleryPreview"></div>
                            <span asp-validation-for="ListAnhPhu" class="text-danger small"></span>
                        </div>
                    </div>
                </div>

                <div class="col-md-8">
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-white fw-bold">Thông tin chi tiết</div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-8">
                                    <label class="form-label">Tên sản phẩm</label>
                                    <input asp-for="TenSanPham" class="form-control" placeholder="Nhập tên sản phẩm..." />
                                    <span asp-validation-for="TenSanPham" class="text-danger small"></span>
                                </div>
                                <div class="col-md-8">
                                    <label class="form-label">Mã Kiểu Dáng</label>
                                    <input asp-for="MaKieuDang" class="form-control" />
                                    <span asp-validation-for="MaKieuDang" class="text-danger small"></span>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Đơn giá (VNĐ)</label>
                                    <input asp-for="DonGia" type="number" class="form-control" />
                                    <span asp-validation-for="DonGia" class="text-danger small"></span>
                                </div>
                            </div>

                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">Loại sản phẩm</label>
                                    <div class="input-group">
                                        <select asp-for="LoaiSanPhamId" id="ddlLoai" class="form-select" asp-items="ViewBag.DanhSachLoaiSanPham"></select>
                                        <button class="btn btn-outline-secondary" type="button" onclick="openModal('Loại sản phẩm', 'Loai')"><i class="fa fa-plus"></i></button>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Thương hiệu</label>
                                    <div class="input-group">
                                        <select asp-for="ThuongHieuId" id="ddlThuongHieu" class="form-select" asp-items="ViewBag.DanhSachThuongHieu"></select>
                                        <button class="btn btn-outline-secondary" type="button" onclick="openModal('Thương hiệu', 'ThuongHieu')"><i class="fa fa-plus"></i></button>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Mô tả sản phẩm</label>
                                <textarea asp-for="MoTa" class="form-control" rows="3"></textarea>
                                <span asp-validation-for="MoTa" class="text-danger small"></span>
                            </div>
                        </div>
                    </div>

                    <div class="card shadow-sm">
                        <div class="card-header bg-white d-flex justify-content-between align-items-center">
                            <span class="fw-bold">Quản lý Phiên bản (Size & Số lượng)</span>
                            <button type="button" class="btn btn-sm btn-success" onclick="themDongSize()">
                                <i class="fa fa-plus-circle me-1"></i> Thêm Size Mới
                            </button>
                        </div>
                        <div class="card-body p-0">
                            <table class="table table-bordered table-striped mb-0 table-size">
                                <thead class="bg-light">
                                    <tr>
                                        <th class="text-center">Kích thước (Size)</th>
                                        <th class="text-center">Số lượng nhập kho</th>
                                        <th class="text-center" style="width: 80px;">Hành động</th>
                                    </tr>
                                </thead>
                                <tbody id="tableBodySize">
                                    @if (Model.Ctsizes != null && Model.Ctsizes.Count > 0)
                                    {
                                        for (int i = 0; i < Model.Ctsizes.Count; i++)
                                        {
                                            <tr>
                                                <input type="hidden" name="Ctsizes[@i].Id" value="@Model.Ctsizes.ElementAt(i).Id" />
                                                <td>
                                                    <input name="Ctsizes[@i].Size" value="@Model.Ctsizes.ElementAt(i).Size" type="number" step="0.5" class="form-control form-control-sm" style="background-color: #e9ecef" />
                                                </td>
                                                <td>
                                                    <input name="Ctsizes[@i].SoLuongTon" value="@Model.Ctsizes.ElementAt(i).SoLuongTon" type="number" class="form-control form-control-sm" required />
                                                </td>
                                                <td class="text-center">
                                                    <button type="button" class="btn btn-danger btn-sm" onclick="xoaDong(this)" title="Xóa size này"><i class="fa fa-trash"></i></button>
                                                </td>
                                            </tr>
                                        }
                                    }
                                    else
                                    {
                                        <tr><td colspan="3" class="text-center text-muted">Chưa có phiên bản size nào</td></tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="d-flex justify-content-end mt-4">
                        <a asp-area="Admin" asp-controller="QuanLySanPham" asp-action="TrangQLSanPham" class="btn btn-secondary me-2">Hủy bỏ</a>
                        <button type="button" class="btn btn-primary px-4" onclick="xacNhanCapNhat()">
                            <i class="fa fa-save me-2"></i> Lưu thay đổi
                        </button>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<div class="modal fade" id="quickAddModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Thêm mới</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="modalType" />
                <div class="mb-3">
                    <label class="form-label">Nhập tên mới:</label>
                    <input type="text" id="modalInputName" class="form-control" placeholder="Nhập tên..." />
                    <span id="errorName" class="text-danger small d-none">Vui lòng nhập tên!</span>
                </div>
                <div class="mb-3 d-none" id="divXuatXu">
                    <label class="form-label">Xuất xứ:</label>
                    <input type="text" id="modalInputOrigin" class="form-control" placeholder="Ví dụ: Việt Nam, Mỹ..." />
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-primary" onclick="luuNhanh()">Lưu lại</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        var sizeIndex = @(Model.Ctsizes != null ? Model.Ctsizes.Count : 0);

        function xacNhanCapNhat() {
            var form = $('#formSanPham');

            $('#tableBodySize input').removeClass('is-invalid');

            if (!form.valid()) {
                return; 
            }

            var coLoiSize = false;

            $('#tableBodySize input').each(function () {
                var input = $(this);
                var giaTri = input.val();
                var minVal = input.attr('min'); 

                if (!giaTri) {
                    coLoiSize = true;
                    input.addClass('is-invalid'); 
                }
                else if (minVal && parseFloat(giaTri) < parseFloat(minVal)) {
                    coLoiSize = true;
                    input.addClass('is-invalid');
                }
            });

            if (coLoiSize) {
                $('html, body').animate({
                    scrollTop: $("#tableBodySize").offset().top - 200
                }, 500);
                return; 
            }

            if (confirm("Bạn có chắc chắn muốn lưu thay đổi không?")) {
                form.submit();
            }
        }

        function previewSingle(input) {
            if (input.files && input.files[0]) {
                var reader = new FileReader();
                reader.onload = function (e) {
                    $('#MainPreview').attr('src', e.target.result).removeClass('d-none');
                    $('#MainIcon').addClass('d-none');
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function previewGallery(input) {
            var container = $('#GalleryPreview');
            container.empty();
            if (input.files) {
                Array.from(input.files).forEach(file => {
                    var reader = new FileReader();
                    reader.onload = function (e) {
                        var img = $('<img>').addClass('gallery-item').attr('src', e.target.result);
                        container.append(img);
                    }
                    reader.readAsDataURL(file);
                });
            }
        }

        // --- HÀM THÊM DÒNG SIZE MỚI ---
        function themDongSize() {
            var html = `
                <tr>
                    <input type="hidden" name="Ctsizes[${sizeIndex}].Id" value="0" />
                    <td>
                        <input name="Ctsizes[${sizeIndex}].Size" 
                               type="number" step="0.5" 
                               class="form-control form-control-sm" 
                               min="34" required 
                               placeholder="Nhập size..." />
                    </td>
                    <td>
                        <input name="Ctsizes[${sizeIndex}].SoLuongTon" 
                               type="number" 
                               class="form-control form-control-sm" 
                               min="1" value="1" required />
                    </td>
                    <td class="text-center">
                        <button type="button" class="btn btn-danger btn-sm" onclick="xoaDong(this)">
                            <i class="fa fa-trash"></i>
                        </button>
                    </td>
                </tr>`;

            $('#tableBodySize').append(html);
            sizeIndex++;
        }

        function xoaDong(btn) {
            $(btn).closest('tr').remove();
        }

        // --- XỬ LÝ MODAL THÊM NHANH  ---
        var myModal = new bootstrap.Modal(document.getElementById('quickAddModal'));

        function openModal(title, type) {
            $('#modalTitle').text('Thêm mới ' + title);
            $('#modalType').val(type);
            $('#modalInputName').val('');
            $('#modalInputOrigin').val('');
            
            // Reset lỗi modal
            $('#errorName').addClass('d-none').text('');
            $('#modalInputName').removeClass('is-invalid');

            if (type === 'ThuongHieu') {
                $('#divXuatXu').removeClass('d-none');
            } else {
                $('#divXuatXu').addClass('d-none');
            }
            myModal.show();
        }

        function luuNhanh() {
            var type = $('#modalType').val();
            var name = $('#modalInputName').val().trim();
            var origin = $('#modalInputOrigin').val().trim();

            // Reset lỗi
            $('#errorName').addClass('d-none');
            $('#modalInputName').removeClass('is-invalid');

            // Validate Client
            if (!name) {
                $('#errorName').text('Vui lòng nhập tên!').removeClass('d-none');
                $('#modalInputName').addClass('is-invalid');
                return;
            }

            $.ajax({
                url: '/Admin/QuanLySanPham/ThemNhanhDuLieu',
                type: 'POST',
                data: { loai: type, ten: name, xuatXu: origin },
                success: function (res) {
                    if (res.success) {
                        var newOption = new Option(res.ten, res.id, true, true);
                        if (type == 'Loai') {
                            $('#ddlLoai').append(newOption).trigger('change');
                        } else {
                            $('#ddlThuongHieu').append(newOption).trigger('change');
                        }
                        myModal.hide();
                    } else {
                        // Hiện lỗi đỏ giống trang thêm
                        $('#errorName').text(res.message).removeClass('d-none');
                        $('#modalInputName').addClass('is-invalid');
                    }
                },
                error: function () {
                    alert('Lỗi kết nối server!');
                }
            });
        }

        // Xóa lỗi khi gõ lại trong modal
        $('#modalInputName').on('input', function() {
            $('#errorName').addClass('d-none');
            $(this).removeClass('is-invalid');
        });
    </script>
}
}