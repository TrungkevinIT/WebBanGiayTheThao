@model WebBanGiayTheThao.ViewModels.UserIndexVM

@{
    Layout = "_LayoutAdmin";
    ViewData["Title"] = "Quản lý tài khoản người dùng";
}

<div class="container-fluid">

    <h4 class="fw-bold mb-4">Quản lý tài khoản người dùng</h4>

    <div class="card border-0 shadow-sm rounded-4">
        <div class="card-body">

            <!-- FORM TÌM KIẾM -->
            <form method="get" class="row g-2 mb-3">
                <div class="col-md-4">
                    <input type="text"
                           name="sdt"
                           value="@Model.Sdt"
                           class="form-control"
                           placeholder="Tìm theo số điện thoại" />
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary w-100">
                        Tìm kiếm
                    </button>
                </div>
            </form>

            <!-- BẢNG NGƯỜI DÙNG -->
            <table class="table table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        <th>ID</th>
                        <th>Username</th>
                        <th>Password</th>
                        <th>Họ và tên</th>
                        <th>SĐT</th>
                        <th>Email</th>
                        <th>Địa chỉ</th>
                        <th>Trạng thái</th>
                        <th class="text-center">Hành động</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model.Users.Any())
                    {
                        @foreach (var u in Model.Users)
                        {
                            <tr>
                                <td>@u.Id</td>
                                <td class="fw-semibold">@u.Username</td>
                                <td>******</td>
                                <td>@u.HoTen</td>
                                <td>@u.Sdt</td>
                                <td>@u.Email</td>
                                <td>@u.DiaChi</td>
                                <td>
                                    @if (u.TrangThai == 0)
                                    {
                                        <span class="badge bg-secondary">Bị khóa</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-success">Hoạt động</span>
                                    }
                                </td>
                                <td class="text-center">
                                    <button class="btn btn-sm @(u.TrangThai == 0 ? "btn-success" : "btn-danger")"
                                            data-bs-toggle="modal"
                                            data-bs-target="#changeStatusModal"
                                            data-userid="@u.Id"
                                            data-username="@u.Username"
                                            data-trangthai="@u.TrangThai">
                                        @(u.TrangThai == 0 ? "Mở khóa" : "Khóa")
                                    </button>
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="9" class="text-center text-muted">
                                Chưa có người dùng
                            </td>
                        </tr>
                    }
                </tbody>
            </table>

            <!-- PHÂN TRANG -->
            <nav>
                <ul class="pagination justify-content-center mt-3">
                    <li class="page-item @(Model.CurrentPage == 1 ? "disabled" : "")">
                        <a class="page-link"
                           href="?page=@(Model.CurrentPage - 1)&sdt=@Model.Sdt">
                            &lt;
                        </a>
                    </li>

                    @for (int i = 1; i <= Model.TotalPages; i++)
                    {
                        <li class="page-item @(i == Model.CurrentPage ? "active" : "")">
                            <a class="page-link"
                               href="?page=@i&sdt=@Model.Sdt">
                                @i
                            </a>
                        </li>
                    }

                    <li class="page-item @(Model.CurrentPage == Model.TotalPages ? "disabled" : "")">
                        <a class="page-link"
                           href="?page=@(Model.CurrentPage + 1)&sdt=@Model.Sdt">
                            &gt;
                        </a>
                    </li>
                </ul>
            </nav>

        </div>
    </div>

</div>

<!-- MODAL THAY ĐỔI TRẠNG THÁI -->
<div class="modal fade" id="changeStatusModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4">

            <form asp-area="Admin"
                  asp-controller="QuanLyNguoiDung"
                  asp-action="ChangeStatus"
                  method="post">

                @Html.AntiForgeryToken()

                <input type="hidden" id="modalUserId" name="userId" />
                <input type="hidden" id="modalTrangThai" name="trangThai" />

                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle"></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <p id="modalMessage"></p>
                </div>

                <div class="modal-footer">
                    <button type="submit"
                            id="modalConfirmBtn"
                            class="btn">
                        Xác nhận
                    </button>
                </div>

            </form>

        </div>
    </div>
</div>

<!-- SCRIPT FIX MODAL BOOTSTRAP 5 -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        var modalEl = document.getElementById('changeStatusModal');

        // Tạo instance modal để tránh lỗi _initializeBackDrop
        var modal = new bootstrap.Modal(modalEl);

        // Lắng nghe sự kiện show.bs.modal
        modalEl.addEventListener('show.bs.modal', function (event) {
            var button = event.relatedTarget;

            var userId = button.getAttribute('data-userid');
            var username = button.getAttribute('data-username');
            var trangThai = button.getAttribute('data-trangthai');

            document.getElementById('modalUserId').value = userId;
            document.getElementById('modalTrangThai').value = trangThai == "1" ? 0 : 1;

            if (trangThai == "0") {
                document.getElementById('modalTitle').innerText = "Xác nhận mở khóa";
                document.getElementById('modalMessage').innerText =
                    `Bạn có chắc muốn mở khóa tài khoản "${username}"?`;
                document.getElementById('modalConfirmBtn').className = "btn btn-success";
            } else {
                document.getElementById('modalTitle').innerText = "Xác nhận khóa";
                document.getElementById('modalMessage').innerText =
                    `Bạn có chắc muốn khóa tài khoản "${username}"?`;
                document.getElementById('modalConfirmBtn').className = "btn btn-danger";
            }
        });
    });
</script>
